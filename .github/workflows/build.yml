name: Build packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Rebuild all packages'
        type: boolean
        default: false
      fix_signatures:
        description: 'Fix database signatures without rebuilding'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    permissions:
      contents: write
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      matrix_heavy: ${{ steps.scan.outputs.matrix_heavy }}
      heavy_runner: ${{ steps.scan.outputs.heavy_runner }}
      removed: ${{ steps.scan.outputs.removed }}
      run_publish: ${{ steps.scan.outputs.run_publish }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Lint PKGBUILDs
        run: ./scripts/lint.sh

      - name: Push checksum fixes
        if: github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --name-only | grep -q PKGBUILD; then
            echo "==> Committing auto-repaired checksums..."
            git config user.name "Updater Bot"
            git config user.email "bot@noreply.github.com"
            git add pkgs/*/PKGBUILD
            git commit -m "fix: auto-repair stale checksums [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: Prepare build matrix
        id: scan
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
          FIX_SIGNATURES: ${{ inputs.fix_signatures }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || github.event.workflow_run.head_commit.message }}
        run: ./scripts/ci/prepare.sh

      - name: Upload Repository DB
        uses: actions/upload-artifact@v4
        with:
          name: repo-db
          path: repo/
          compression-level: 0

  aur-publish:
    needs: prepare
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Publish to AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
          AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
        run: ./scripts/ci/aur-publish.sh

  build:
    needs: [prepare]
    if: ${{ always() && needs.prepare.result == 'success' && fromJson(needs.prepare.outputs.matrix)[0] != null }}
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Build packages sequentially
        env:
          PACKAGES: ${{ needs.prepare.outputs.matrix }}
        run: |
          # Build packages one by one, each gets added to local repo
          # so subsequent packages can depend on earlier ones
          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "::group::Building $pkg"
            ./scripts/ci/build.sh "$pkg"
            echo "::endgroup::"
          done

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: pkgs/*/*.pkg.tar.zst
          compression-level: 0

  build-heavy:
    needs: [prepare]
    if: ${{ always() && needs.prepare.result == 'success' && fromJson(needs.prepare.outputs.matrix_heavy)[0] != null }}
    runs-on: ${{ needs.prepare.outputs.heavy_runner }}
    container: archlinux:base-devel
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Build packages sequentially
        env:
          PACKAGES: ${{ needs.prepare.outputs.matrix_heavy }}
        run: |
          # Build packages one by one, each gets added to local repo
          # so subsequent packages can depend on earlier ones
          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "::group::Building $pkg"
            ./scripts/ci/build.sh "$pkg"
            echo "::endgroup::"
          done

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-heavy
          path: pkgs/*/*.pkg.tar.zst
          compression-level: 0

  publish:
    needs: [prepare, build, build-heavy]
    # Run if prepare succeeded, and both build jobs either succeeded or were skipped, AND we are told to publish
    if: |
      always() &&
      needs.prepare.result == 'success' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (needs.build-heavy.result == 'success' || needs.build-heavy.result == 'skipped') &&
      needs.prepare.outputs.run_publish == 'true' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.ref == 'refs/heads/main'
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Import GPG key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Download Repository DB
        uses: actions/download-artifact@v4
        with:
          name: repo-db
          path: repo

      - name: Download Built Packages
        # Only download if build job ran
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: repo-artifacts

      - name: Download Heavy Built Packages
        if: needs.build-heavy.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: packages-heavy
          path: repo-artifacts

      - name: Finalize Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          REMOVED_JSON: ${{ needs.prepare.outputs.removed }}
        run: ./scripts/ci/publish.sh

      - name: Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REMOVED_JSON: ${{ needs.prepare.outputs.removed }}
        run: ./scripts/ci/release.sh
